@{
    ViewData["Title"] = "Calcular Total de Pagos por Paciente";
}

<div class="container mt-4">
    <h1 class="display-4 text-center mb-4">Calcular Total de Pagos por Paciente</h1>

    <!-- Formulario para ingresar los datos -->
    <form id="formCalcularPagos" class="mb-4">
        <div class="form-group">
            <label for="cedulaPaciente">Cédula del Paciente</label>
            <input type="text" class="form-control" id="cedulaPaciente" name="cedulaPaciente" required>
        </div>
        <div class="form-group">
            <label for="fechaInicio">Fecha de Inicio</label>
            <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" required>
        </div>
        <div class="form-group">
            <label for="fechaFin">Fecha de Fin</label>
            <input type="date" class="form-control" id="fechaFin" name="fechaFin" required>
        </div>
        <button type="submit" class="btn btn-primary">
            <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Calcular
        </button>
    </form>

    <!-- Resultados -->
    <h2>Resultados</h2>
    <div id="resultados" class="mt-3">
        <div class="alert alert-info d-none" id="resultadoMensaje"></div>
        <table class="table table-bordered table-striped d-none" id="tablaResultados">
            <thead>
                <tr>
                    <th>Cédula del Paciente</th>
                    <th>Total de Pagos</th>
                    <th>Cantidad de Pagos</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se llenarán dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#formCalcularPagos").submit(function (e) {
                e.preventDefault(); // Evita que el formulario se envíe de forma tradicional

                var cedulaPaciente = $("#cedulaPaciente").val();
                var fechaInicio = $("#fechaInicio").val();
                var fechaFin = $("#fechaFin").val();

                // Validar que la cédula no esté vacía
                if (!cedulaPaciente) {
                    alert("Por favor, ingrese la cédula del paciente.");
                    return;
                }

                // Validar que las fechas no estén vacías
                if (!fechaInicio || !fechaFin) {
                    alert("Por favor, ingrese ambas fechas.");
                    return;
                }

                // Mostrar el spinner de carga
                $("#loadingSpinner").removeClass("d-none");

                $.ajax({
                    url: "@Url.Action("TotalPagos", "Administradores")", // Cambia "TuControlador" por el nombre de tu controlador
                    type: "POST",
                    data: {
                        cedulaPaciente: cedulaPaciente,
                        fechaInicio: fechaInicio,
                        fechaFin: fechaFin
                    },
                    success: function (response) {
                        console.log(response); // Imprime la respuesta en la consola

                        // Ocultar el spinner de carga
                        $("#loadingSpinner").addClass("d-none");

                        if (response.success) {
                            // Mostrar los resultados
                            $("#resultadoMensaje").addClass("d-none");
                            $("#tablaResultados").removeClass("d-none");

                            // Limpiar la tabla antes de agregar nuevos datos
                            $("#tablaResultados tbody").empty();

                            // Agregar los datos a la tabla
                            $("#tablaResultados tbody").append(
                                `<tr>
                                    <td>${response.data.cedulaPaciente}</td>
                                    <td>${formatCurrency(response.data.totalPagos)}</td>
                                    <td>${response.data.cantidadPagos}</td>
                                </tr>`
                            );
                        } else {
                            // Mostrar mensaje de error
                            $("#resultadoMensaje").text(response.message).removeClass("d-none");
                            $("#tablaResultados").addClass("d-none");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", status, error);

                        // Ocultar el spinner de carga
                        $("#loadingSpinner").addClass("d-none");

                        // Mostrar mensaje de error
                        $("#resultadoMensaje").text("Ocurrió un error al procesar la solicitud. Inténtelo de nuevo más tarde.").removeClass("d-none");
                        $("#tablaResultados").addClass("d-none");
                    }
                });
            });

            // Función para formatear montos como moneda
            function formatCurrency(amount) {
                return new Intl.NumberFormat("es-CR", { style: "currency", currency: "CRC" }).format(amount);
            }
        });
    </script>
}